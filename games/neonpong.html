<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Neon Pong - Arcade</title>
<style>
:root{--bg:#05070d;--neon:#43f3ff;--hot:#ff4fd8;--ok:#8cff6b;--gold:#ffd700;--warn:#ff6347}
*{box-sizing:border-box;touch-action:manipulation;-webkit-tap-highlight-color:transparent}
html,body{margin:0;padding:0;width:100%;height:100%;overflow:hidden}
body{display:flex;flex-direction:column;align-items:center;justify-content:center;background:radial-gradient(ellipse at 30% 15%,#11162a 0%,var(--bg) 60%);color:#dbe7ff;font-family:Inter,system-ui,sans-serif}
.wrap{width:min(420px,100vw);height:100vh;height:100dvh;display:flex;flex-direction:column;position:relative;padding:4px}
.hud{display:flex;justify-content:space-between;align-items:center;gap:4px;padding:2px 0;flex-shrink:0;font-size:.8rem}
.badge{padding:3px 8px;border:1px solid #2b355f;border-radius:999px;background:#0b1022;white-space:nowrap}
.badge.combo{color:var(--gold);border-color:#665500;transition:transform .15s}
.badge.combo.pop{transform:scale(1.25)}
.btn{background:#0d1430;border:1px solid #324079;color:#dbe7ff;padding:4px 10px;border-radius:10px;cursor:pointer;font-size:.8rem}
.btn:active{background:#1a2550}
canvas{flex:1;width:100%;min-height:0;border:1px solid #1e2a50;border-radius:10px;background:#060913;box-shadow:0 0 30px #0ef1 inset}
.info{font-size:.7rem;opacity:.55;text-align:center;padding:2px 0;flex-shrink:0}
.toast{position:absolute;top:45%;left:50%;transform:translate(-50%,-50%);font-size:1.3rem;font-weight:700;color:var(--gold);text-shadow:0 0 20px var(--gold);opacity:0;transition:opacity .3s,transform .3s;pointer-events:none;z-index:5}
.toast.show{opacity:1;transform:translate(-50%,-60%)}

.overlay{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(5,7,13,.9);border-radius:10px;z-index:10;gap:12px;padding:20px;text-align:center;backdrop-filter:blur(6px)}
.overlay h2{margin:0;font-size:1.4rem;letter-spacing:1px}
.overlay p{margin:0;opacity:.85;font-size:.9rem;max-width:320px;line-height:1.4}
.overlay .stars{font-size:1.8rem;letter-spacing:6px;margin:4px 0}
.overlay .btn-big{padding:10px 28px;font-size:1rem;border-radius:14px;border:1px solid var(--neon);color:var(--neon);background:#0a1535;cursor:pointer}
.overlay .btn-big:active{background:#132050}
.level-list{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin-top:6px}
.level-cell{padding:8px 4px;border-radius:8px;border:1px solid #2a3560;background:#0c1330;cursor:pointer;text-align:center;font-size:.8rem}
.level-cell.locked{opacity:.35;pointer-events:none}
.level-cell.current{border-color:var(--neon)}
.level-cell .cs{font-size:.65rem;display:block;margin-top:1px}
</style>
</head>
<body>
<div class="wrap" id="wrap">
  <div class="hud">
    <div class="badge" id="levelBadge">Lv.1</div>
    <div class="badge" id="score">0 : 0</div>
    <div class="badge combo" id="combo"></div>
    <button class="btn" id="menuBtn">‚ò∞</button>
  </div>
  <canvas id="game"></canvas>
  <div class="info">Parmaƒüƒ±nƒ± alt raket √ºzerinde s√ºr√ºkle</div>
  <div class="toast" id="toast"></div>

  <div class="overlay" id="menuOverlay" style="display:none">
    <h2>üèì NEON PONG</h2>
    <p>B√∂l√ºmler</p>
    <div class="level-list" id="levelList"></div>
    <button class="btn-big" id="resumeBtn">Devam Et</button>
  </div>

  <div class="overlay" id="startOverlay">
    <h2 id="startTitle">LEVEL 1</h2>
    <p id="startDesc"></p>
    <button class="btn-big" id="startBtn">BA≈ûLA</button>
  </div>

  <div class="overlay" id="winOverlay" style="display:none">
    <h2>B√ñL√úM TAMAM!</h2>
    <div class="stars" id="winStars"></div>
    <p id="winStats"></p>
    <button class="btn-big" id="nextBtn">SONRAKƒ∞ ‚Üí</button>
  </div>

  <div class="overlay" id="loseOverlay" style="display:none">
    <h2 style="color:var(--warn)">YENƒ∞LDƒ∞N</h2>
    <p id="loseStats"></p>
    <button class="btn-big" id="retryBtn">TEKRAR DENE</button>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NEON PONG v3 ‚Äî VERTICAL LAYOUT
// Paddles: top (CPU) & bottom (Player)
// Ball bounces off left/right walls
// Touch: drag horizontally on bottom half
// Keyboard: A/D or ‚Üê/‚Üí
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const $ = id => document.getElementById(id);
const c = $('game'), ctx = c.getContext('2d');
const dpr = Math.min(window.devicePixelRatio || 1, 2);

// ‚îÄ‚îÄ LEVELS ‚îÄ‚îÄ
// cpuMaxSpd = max px/frame movement (smooth, speed-limited)
// cpuNapChance = probability per second of CPU "napping" (mistake)
// cpuNapDur = nap duration range in ms [min, max]
// cpuReactDelay = ms delay before CPU reacts to ball direction change
const LEVELS = [
  { name:'Uyanƒ±≈ü',       desc:'Yava≈ü top, yava≈ü CPU. Alƒ±≈ü.',                        cpuMaxSpd:.25, cpuNapChance:.8,  cpuNapDur:[400,900],  cpuReactDelay:280, ballSpeed:3.5, winScore:5,  puRate:0,    multi:false, walls:false, accel:1.018 },
  { name:'Isƒ±nma',        desc:'Top biraz hƒ±zlandƒ±.',                                 cpuMaxSpd:.28, cpuNapChance:.65, cpuNapDur:[350,800],  cpuReactDelay:240, ballSpeed:4.0, winScore:5,  puRate:0,    multi:false, walls:false, accel:1.020 },
  { name:'ƒ∞lk G√º√ß',      desc:'Power-up\'lar sahneye √ßƒ±kƒ±yor!',                      cpuMaxSpd:.30, cpuNapChance:.55, cpuNapDur:[300,750],  cpuReactDelay:220, ballSpeed:4.2, winScore:5,  puRate:.12,  multi:false, walls:false, accel:1.020 },
  { name:'Baskƒ±',         desc:'CPU biraz daha akƒ±llƒ±.',                              cpuMaxSpd:.33, cpuNapChance:.45, cpuNapDur:[280,650],  cpuReactDelay:190, ballSpeed:4.5, winScore:6,  puRate:.14,  multi:false, walls:false, accel:1.022 },
  { name:'Daralan',       desc:'CPU raketi k√º√ß√ºl√ºyor ama daha iyi.',                  cpuMaxSpd:.36, cpuNapChance:.38, cpuNapDur:[250,600],  cpuReactDelay:170, ballSpeed:4.8, winScore:6,  puRate:.14,  multi:false, walls:false, accel:1.025, shrinkCPU:true },
  { name:'Kaos',          desc:'√áift top geliyor!',                                   cpuMaxSpd:.32, cpuNapChance:.42, cpuNapDur:[300,700],  cpuReactDelay:200, ballSpeed:4.5, winScore:6,  puRate:.15,  multi:true,  walls:false, accel:1.022 },
  { name:'Labirent',      desc:'Sahada engeller var.',                                cpuMaxSpd:.35, cpuNapChance:.35, cpuNapDur:[250,550],  cpuReactDelay:160, ballSpeed:5.0, winScore:7,  puRate:.15,  multi:false, walls:true,  accel:1.025 },
  { name:'Fƒ±rtƒ±na',       desc:'Her ≈üey bir arada.',                                 cpuMaxSpd:.38, cpuNapChance:.30, cpuNapDur:[200,500],  cpuReactDelay:140, ballSpeed:5.2, winScore:7,  puRate:.16,  multi:true,  walls:true,  accel:1.028, shrinkCPU:true },
  { name:'Son Sƒ±nav',     desc:'CPU hƒ±zlƒ± ama m√ºkemmel deƒüil.',                       cpuMaxSpd:.42, cpuNapChance:.22, cpuNapDur:[180,450],  cpuReactDelay:110, ballSpeed:5.5, winScore:8,  puRate:.14,  multi:false, walls:true,  accel:1.030, shrinkCPU:true },
  { name:'Efsane',        desc:'Buraya kadar gelen az. Kanƒ±tla.',                     cpuMaxSpd:.45, cpuNapChance:.15, cpuNapDur:[150,380],  cpuReactDelay:80,  ballSpeed:5.8, winScore:10, puRate:.16,  multi:true,  walls:true,  accel:1.032, shrinkCPU:true },
];

const THEMES = [
  { pad:'#43f3ff', cpu:'#ff4fd8', ball:'#8cff6b' },
  { pad:'#00e5ff', cpu:'#ff6090', ball:'#b2ff59' },
  { pad:'#64ffda', cpu:'#ff4081', ball:'#ffff00' },
  { pad:'#18ffff', cpu:'#f50057', ball:'#76ff03' },
  { pad:'#00bcd4', cpu:'#e91e63', ball:'#cddc39' },
  { pad:'#26c6da', cpu:'#ec407a', ball:'#ffd740' },
  { pad:'#4dd0e1', cpu:'#f06292', ball:'#ff6e40' },
  { pad:'#80deea', cpu:'#ff80ab', ball:'#ffd180' },
  { pad:'#b2ebf2', cpu:'#ff80ab', ball:'#ff9100' },
  { pad:'#ffd700', cpu:'#ff1744', ball:'#ffffff' },
];

const PU_TYPES = [
  { id:'big',    icon:'üî≤', label:'B√úY√úK RAKET',  color:'#43f3ff', dur:7000 },
  { id:'slow',   icon:'üïê', label:'YAVA≈û MOD',    color:'#b388ff', dur:4500 },
  { id:'shrink', icon:'üìè', label:'CPU K√ú√á√úLT',    color:'#ff4081', dur:6000 },
  { id:'multi',  icon:'‚ö°', label:'√áƒ∞FT TOP',     color:'#ffff00', dur:0 },
];

// ‚îÄ‚îÄ SAVE ‚îÄ‚îÄ
const SAVE_KEY = 'neonpong_v3';
let save = JSON.parse(localStorage.getItem(SAVE_KEY)||'null') || { unlocked:1, stars:[], hi:[] };
const persist = () => localStorage.setItem(SAVE_KEY, JSON.stringify(save));

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let W, H;
let lv, currentLevel = 0;
let playing = false, paused = false;
let scoreP1 = 0, scoreP2 = 0; // P1 = player (bottom), P2 = cpu (top)
let combo = 0, maxCombo = 0, comboTimer = 0;
let ddaOffset = 0, rally = 0;
// CPU brain state
let cpuBrain = { napping:false, napEnd:0, napDir:0, lastBallVy:0, reactLock:0 };
let puTimer = 0;
let effects = { bigPaddle:0, slowMo:0 };

// Paddles: horizontal bars
let player, cpu;
let balls = [], powerups = [], obstacles = [], particles = [];
let shake = { x:0, y:0, intensity:0 };

// Input
const keys = new Set();
let touchX = null; // null = not touching

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
const clamp = (v,a,b) => Math.max(a,Math.min(b,v));
const rand = (a,b) => a + Math.random()*(b-a);
const randInt = (a,b) => Math.floor(rand(a,b+1));

// ‚îÄ‚îÄ RESIZE ‚îÄ‚îÄ
function resize() {
  const rect = c.getBoundingClientRect();
  W = Math.round(rect.width * dpr);
  H = Math.round(rect.height * dpr);
  c.width = W; c.height = H;
}

function initPaddles() {
  const pw = Math.round(W * 0.22);
  const ph = Math.round(H * 0.015);
  const margin = Math.round(H * 0.04);

  player = { x:(W-pw)/2, y:H - margin - ph, w:pw, h:ph, baseW:pw, speed:W*0.04 };
  cpu    = { x:(W-pw)/2, y:margin,           w:pw, h:ph, baseW:pw, speed:0 };
  if (lv && lv.shrinkCPU) cpu.w = Math.round(pw * 0.7);
}

function makeBall(center) {
  const spd = lv ? lv.ballSpeed * (H/800) : 4;
  // Launch upward or downward randomly, angled
  const dir = center ? (Math.random()<.5?-1:1) : -1;
  const angle = rand(0.4, 1.1) * (Math.random()<.5?-1:1);
  return {
    x: center ? W/2 : rand(W*.2, W*.8),
    y: H/2,
    vx: Math.sin(angle) * spd,
    vy: Math.cos(angle) * spd * dir,
    r: Math.round(W*0.018+2),
    trail: [],
    alive: true,
    lastHit: 0
  };
}

function initObstacles() {
  obstacles = [];
  if (!lv || !lv.walls) return;
  const count = currentLevel >= 9 ? 3 : 2;
  for (let i = 0; i < count; i++) {
    const horiz = Math.random() < 0.6;
    obstacles.push({
      x: rand(W*0.15, W*0.85),
      y: rand(H*0.25, H*0.75),
      w: horiz ? rand(W*0.12, W*0.22) : Math.round(W*0.02),
      h: horiz ? Math.round(H*0.01) : rand(H*0.06, H*0.12),
      color: THEMES[currentLevel].ball + '55'
    });
  }
}

// ‚îÄ‚îÄ INPUT ‚îÄ‚îÄ
addEventListener('keydown', e => { keys.add(e.key.toLowerCase()); if(['arrowleft','arrowright','a','d'].includes(e.key.toLowerCase())) e.preventDefault(); });
addEventListener('keyup', e => keys.delete(e.key.toLowerCase()));

c.addEventListener('touchstart', onTouch, {passive:false});
c.addEventListener('touchmove', onTouch, {passive:false});
c.addEventListener('touchend', () => touchX = null);
c.addEventListener('touchcancel', () => touchX = null);

// Mouse support for desktop
c.addEventListener('mousedown', e => { const r=c.getBoundingClientRect(); touchX=(e.clientX-r.left)/r.width*W; });
c.addEventListener('mousemove', e => { if(e.buttons&1){const r=c.getBoundingClientRect(); touchX=(e.clientX-r.left)/r.width*W;} });
c.addEventListener('mouseup', () => touchX=null);

function onTouch(e) {
  const t = e.touches[0]; if (!t) return;
  const r = c.getBoundingClientRect();
  touchX = (t.clientX - r.left) / r.width * W;
  e.preventDefault();
}

// ‚îÄ‚îÄ PARTICLES ‚îÄ‚îÄ
function emit(x,y,color,count,spread) {
  for(let i=0;i<count;i++){
    const a=rand(0,Math.PI*2), s=rand(1,spread);
    particles.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:1,decay:rand(.015,.04),r:rand(1.5,4),color});
  }
}

function doShake(n){ shake.intensity=Math.max(shake.intensity,n); }

// ‚îÄ‚îÄ COMBO ‚îÄ‚îÄ
function addCombo(){
  combo++; if(combo>maxCombo) maxCombo=combo;
  comboTimer=3500;
  const el=$('combo');
  el.textContent = combo>=2 ? `üî•x${combo}` : '';
  el.classList.remove('pop'); void el.offsetWidth; el.classList.add('pop');
  if(combo===5) showToast('üî• ON FIRE!');
  if(combo===10) showToast('üíé UNSTOPPABLE!');
}
function breakCombo(){
  if(combo>=3){ doShake(5); emit(player.x+player.w/2, player.y, '#ff4444', 18, 4); showToast('üíî Kombo kƒ±rƒ±ldƒ±!'); }
  combo=0; $('combo').textContent='';
}
function showToast(t){ const el=$('toast'); el.textContent=t; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),1200); }

// ‚îÄ‚îÄ POWERUP ‚îÄ‚îÄ
function spawnPU(){
  if(!lv||!lv.puRate||powerups.length>=2) return;
  const type = PU_TYPES[randInt(0,PU_TYPES.length-1)];
  if(type.id==='multi'&&balls.length>=3) return;
  powerups.push({...type, x:rand(W*.15,W*.85), y:rand(H*.3,H*.7), size:W*0.04, pulse:0, age:0});
}

function activatePU(pu){
  switch(pu.id){
    case 'big': effects.bigPaddle=Date.now()+pu.dur; player.w=Math.round(player.baseW*1.5); break;
    case 'slow': effects.slowMo=Date.now()+pu.dur; break;
    case 'shrink': cpu.w=Math.round(cpu.baseW*.45); setTimeout(()=>{cpu.w=lv&&lv.shrinkCPU?Math.round(cpu.baseW*.7):cpu.baseW;},pu.dur); break;
    case 'multi': if(balls.length<3) balls.push(makeBall(true)); break;
  }
}

// ‚îÄ‚îÄ COLLISIONS ‚îÄ‚îÄ
function collidePaddle(ball, pad, dirY){
  const now=Date.now();
  if(now-ball.lastHit<60) return false;
  // dirY: 1 = bounce downward (hit top paddle), -1 = bounce upward (hit bottom paddle)
  if(ball.x+ball.r > pad.x && ball.x-ball.r < pad.x+pad.w &&
     ball.y+ball.r > pad.y && ball.y-ball.r < pad.y+pad.h){
    ball.lastHit=now;
    ball.vy = Math.abs(ball.vy) * dirY;
    // Angle based on hit position
    const rel = (ball.x - (pad.x+pad.w/2)) / (pad.w/2);
    ball.vx += rel * 2.5;
    // Accelerate
    const accel = lv ? lv.accel : 1.02;
    ball.vy *= accel;
    // Clamp
    const maxV = H * 0.018;
    ball.vx = clamp(ball.vx, -maxV*.8, maxV*.8);
    ball.vy = clamp(ball.vy, -maxV, maxV);

    rally++;
    const theme = THEMES[currentLevel];
    emit(ball.x, ball.y, dirY===1?theme.cpu:theme.pad, 10, 3);
    doShake(2.5);

    if(dirY===-1){ // player hit
      addCombo();
      if(lv && lv.puRate && Math.random() < lv.puRate) spawnPU();
    }
    return true;
  }
  return false;
}

function collideObstacle(ball){
  for(const w of obstacles){
    if(ball.x+ball.r>w.x && ball.x-ball.r<w.x+w.w && ball.y+ball.r>w.y && ball.y-ball.r<w.y+w.h){
      const oL=(ball.x+ball.r)-w.x, oR=(w.x+w.w)-(ball.x-ball.r);
      const oT=(ball.y+ball.r)-w.y, oB=(w.y+w.h)-(ball.y-ball.r);
      if(Math.min(oL,oR)<Math.min(oT,oB)) ball.vx*=-1; else ball.vy*=-1;
      emit(ball.x,ball.y,THEMES[currentLevel].ball,6,2.5);
      doShake(1.5);
    }
  }
}

function collidePU(ball){
  for(let i=powerups.length-1;i>=0;i--){
    const pu=powerups[i];
    if(Math.hypot(ball.x-pu.x,ball.y-pu.y)<ball.r+pu.size){
      activatePU(pu); emit(pu.x,pu.y,pu.color,20,5); doShake(3);
      showToast(`${pu.icon} ${pu.label}`);
      powerups.splice(i,1);
    }
  }
}

// ‚îÄ‚îÄ CPU AI ‚îÄ‚îÄ
// Speed-limited + nap (mistake) system + reaction delay
// CPU has a max speed per frame and randomly "naps" ‚Äî drifts wrong direction
function updateCPU(rawDt){
  const now = Date.now();

  // --- Nap system: random mistakes ---
  if(!cpuBrain.napping){
    // Roll for nap (chance per second)
    const chance = (lv ? lv.cpuNapChance : .5) * rawDt;
    if(Math.random() < chance){
      cpuBrain.napping = true;
      const durRange = lv ? lv.cpuNapDur : [300,700];
      cpuBrain.napEnd = now + rand(durRange[0], durRange[1]);
      cpuBrain.napDir = Math.random() < .5 ? -1 : 1; // drift random direction
    }
  }
  if(cpuBrain.napping && now > cpuBrain.napEnd){
    cpuBrain.napping = false;
  }

  // --- Reaction delay: ignore ball direction changes briefly ---
  let trackBall = null;
  let bestDist = Infinity;
  for(const b of balls){
    if(!b.alive) continue;
    // Detect direction change ‚Üí lock reaction
    if(b.vy < 0){ // heading toward CPU
      const d = b.y - cpu.y;
      if(d > 0 && d < bestDist){ bestDist = d; trackBall = b; }
    }
  }
  // If no ball heading up, lazily track closest
  if(!trackBall){
    for(const b of balls){
      if(!b.alive) continue;
      const d = Math.abs(b.y - cpu.y);
      if(d < bestDist){ bestDist = d; trackBall = b; }
    }
  }

  // Detect ball vertical direction flip ‚Üí apply reaction delay
  if(trackBall){
    const curVy = trackBall.vy;
    if(Math.sign(curVy) !== Math.sign(cpuBrain.lastBallVy) && cpuBrain.lastBallVy !== 0){
      cpuBrain.reactLock = now + (lv ? lv.cpuReactDelay : 200);
    }
    cpuBrain.lastBallVy = curVy;
  }

  // --- Movement ---
  const maxSpd = (lv ? lv.cpuMaxSpd : .3) * W * rawDt * 60; // normalize to ~60fps
  const center = cpu.x + cpu.w / 2;

  if(cpuBrain.napping){
    // During nap: drift in random direction at half speed
    cpu.x += cpuBrain.napDir * maxSpd * 0.5;
  } else if(now < cpuBrain.reactLock){
    // During react delay: hold position (slight drift toward center)
    const toCenter = W/2 - center;
    cpu.x += clamp(toCenter, -maxSpd*.2, maxSpd*.2);
  } else if(trackBall){
    // Normal tracking with speed limit
    const targetX = trackBall.x;
    const diff = targetX - center;
    const move = clamp(diff, -maxSpd, maxSpd);
    cpu.x += move;
  }

  cpu.x = clamp(cpu.x, 0, W - cpu.w);
}

// ‚îÄ‚îÄ SCORING ‚îÄ‚îÄ
function playerScored(){
  scoreP1++; rally=0; updateHUD();
  emit(W/2, cpu.y, '#8cff6b', 25, 6); doShake(4);
  if(scoreP1-scoreP2>=3) ddaOffset=clamp(ddaOffset+.01, -.08, .08);
  checkWin();
}
function cpuScored(){
  scoreP2++; rally=0; breakCombo(); updateHUD();
  emit(W/2, player.y, '#ff4444', 25, 6); doShake(5);
  if(scoreP2-scoreP1>=2) ddaOffset=clamp(ddaOffset-.015, -.08, .08);
  checkWin();
}

function checkWin(){
  const target=lv?lv.winScore:5;
  if(scoreP1>=target){
    playing=false;
    const stars=calcStars();
    save.stars[currentLevel]=Math.max(save.stars[currentLevel]||0, stars);
    if(currentLevel+1>=save.unlocked) save.unlocked=Math.min(currentLevel+2, LEVELS.length);
    persist(); showWin(stars);
  } else if(scoreP2>=target){
    playing=false; showLose();
  } else {
    respawnBalls();
  }
}

function calcStars(){
  const diff=scoreP1-scoreP2;
  if(diff>=4&&maxCombo>=5) return 3;
  if(diff>=2) return 2;
  return 1;
}

function respawnBalls(){
  balls=[makeBall(true)];
  if(lv&&lv.multi&&Math.random()<.25) setTimeout(()=>{if(playing) balls.push(makeBall(true));},2200);
}

function updateHUD(){
  $('score').textContent=`${scoreP1} : ${scoreP2}`;
  $('levelBadge').textContent=`Lv.${currentLevel+1} ${lv?lv.name:''}`;
}

// ‚îÄ‚îÄ OVERLAYS ‚îÄ‚îÄ
function hideAll(){ ['menuOverlay','startOverlay','winOverlay','loseOverlay'].forEach(id=>$(id).style.display='none'); }
function showStart(){ hideAll(); $('startOverlay').style.display='flex'; $('startTitle').textContent=`LEVEL ${currentLevel+1}: ${LEVELS[currentLevel].name}`; $('startDesc').textContent=LEVELS[currentLevel].desc; }
function showWin(stars){ hideAll(); $('winOverlay').style.display='flex'; $('winStars').textContent='‚≠ê'.repeat(stars)+'‚òÜ'.repeat(3-stars); $('winStats').textContent=`Skor: ${scoreP1}-${scoreP2} ‚Ä¢ Max Kombo: x${maxCombo}`; for(let i=0;i<50;i++) emit(rand(0,W),rand(0,H),THEMES[currentLevel].pad,1,3); }
function showLose(){ hideAll(); $('loseOverlay').style.display='flex'; $('loseStats').textContent=`Skor: ${scoreP1}-${scoreP2} ‚Ä¢ Max Kombo: x${maxCombo}`; }
function showMenu(){
  paused=true; hideAll(); $('menuOverlay').style.display='flex';
  const list=$('levelList'); list.innerHTML='';
  for(let i=0;i<LEVELS.length;i++){
    const cell=document.createElement('div');
    cell.className='level-cell'+(i>=save.unlocked?' locked':'')+(i===currentLevel?' current':'');
    const st=save.stars[i]?'‚≠ê'.repeat(save.stars[i]):(i<save.unlocked?'‚Äî':'üîí');
    cell.innerHTML=`<strong>${i+1}</strong><span class="cs">${st}</span>`;
    if(i<save.unlocked) cell.onclick=()=>{currentLevel=i;startLevel();};
    list.appendChild(cell);
  }
}

// ‚îÄ‚îÄ START ‚îÄ‚îÄ
function startLevel(){
  hideAll();
  lv=LEVELS[currentLevel];
  scoreP1=0;scoreP2=0;combo=0;maxCombo=0;comboTimer=0;ddaOffset=0;rally=0;puTimer=0;
  cpuBrain={napping:false,napEnd:0,napDir:0,lastBallVy:0,reactLock:0};
  effects={bigPaddle:0,slowMo:0};
  powerups=[];particles=[];
  $('combo').textContent='';
  resize(); initPaddles(); initObstacles(); respawnBalls(); updateHUD(); showStart();
}

// ‚îÄ‚îÄ LOOP ‚îÄ‚îÄ
let lastT=0;
function loop(ts){
  const rawDt=Math.min((ts-lastT)/1000,.05); lastT=ts;
  const slow=(effects.slowMo>Date.now())?.5:1;
  const dt=rawDt*slow;

  if(playing&&!paused){
    // Player input
    if(touchX!==null){
      player.x=clamp(touchX-player.w/2, 0, W-player.w);
    } else {
      let pv=0;
      if(keys.has('a')||keys.has('arrowleft')) pv=-player.speed;
      if(keys.has('d')||keys.has('arrowright')) pv=player.speed;
      player.x=clamp(player.x+pv, 0, W-player.w);
    }

    // Big paddle expiry
    if(effects.bigPaddle>0&&effects.bigPaddle<Date.now()){ player.w=player.baseW; effects.bigPaddle=0; }

    updateCPU(rawDt);

    // Balls
    for(const b of balls){
      if(!b.alive) continue;
      b.x+=b.vx; b.y+=b.vy;
      b.trail.push({x:b.x,y:b.y}); if(b.trail.length>14) b.trail.shift();

      // Left/right walls
      if(b.x-b.r<0){ b.x=b.r; b.vx=Math.abs(b.vx); emit(0,b.y,'#223',4,2); }
      if(b.x+b.r>W){ b.x=W-b.r; b.vx=-Math.abs(b.vx); emit(W,b.y,'#223',4,2); }

      collideObstacle(b);
      collidePaddle(b, cpu, 1);    // hit top paddle ‚Üí bounce down
      collidePaddle(b, player, -1); // hit bottom paddle ‚Üí bounce up
      collidePU(b);

      // Score
      if(b.y<-30){ b.alive=false; playerScored(); }
      if(b.y>H+30){ b.alive=false; cpuScored(); }
    }

    balls=balls.filter(b=>b.alive);
    if(balls.length===0&&playing) respawnBalls();

    // Combo decay
    if(combo>0){ comboTimer-=rawDt*1000; if(comboTimer<=0) breakCombo(); }

    // PU timer
    if(lv&&lv.puRate){ puTimer+=rawDt*1000; if(puTimer>rand(7000,15000)){puTimer=0;spawnPU();} }

    // PU age
    for(let i=powerups.length-1;i>=0;i--){
      powerups[i].age+=rawDt*1000; powerups[i].pulse+=rawDt*3;
      if(powerups[i].age>11000){emit(powerups[i].x,powerups[i].y,powerups[i].color,8,3);powerups.splice(i,1);}
    }
  }

  // Particles always
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i]; p.x+=p.vx; p.y+=p.vy; p.life-=p.decay; p.vy+=.015;
    if(p.life<=0) particles.splice(i,1);
  }

  if(shake.intensity>.3){ shake.x=rand(-shake.intensity,shake.intensity); shake.y=rand(-shake.intensity,shake.intensity); shake.intensity*=.87; }
  else{ shake.x=0;shake.y=0;shake.intensity=0; }

  draw();
  requestAnimationFrame(loop);
}

// ‚îÄ‚îÄ DRAW ‚îÄ‚îÄ
function draw(){
  const th=THEMES[currentLevel]||THEMES[0];
  ctx.save(); ctx.translate(shake.x,shake.y);

  ctx.fillStyle='#060913'; ctx.fillRect(-10,-10,W+20,H+20);

  // Center line (horizontal)
  ctx.strokeStyle='#151e3a'; ctx.lineWidth=1.5*dpr; ctx.setLineDash([6*dpr,12*dpr]);
  ctx.beginPath(); ctx.moveTo(0,H/2); ctx.lineTo(W,H/2); ctx.stroke(); ctx.setLineDash([]);

  // Obstacles
  for(const w of obstacles){
    ctx.shadowBlur=8; ctx.shadowColor=th.ball;
    ctx.fillStyle=w.color; ctx.fillRect(w.x,w.y,w.w,w.h);
    ctx.shadowBlur=0;
  }

  // Ball trails
  for(const b of balls){
    for(let i=0;i<b.trail.length;i++){
      const t=b.trail[i], a=(i+1)/b.trail.length;
      ctx.fillStyle=hexA(th.ball,a*.3);
      ctx.beginPath(); ctx.arc(t.x,t.y,b.r*(.3+a*.7),0,Math.PI*2); ctx.fill();
    }
  }

  // Balls
  for(const b of balls){
    ctx.shadowBlur=18*dpr; ctx.shadowColor=th.ball; ctx.fillStyle=th.ball;
    ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill(); ctx.shadowBlur=0;
  }

  // Paddles
  drawPad(player, th.pad);
  drawPad(cpu, th.cpu);

  // Powerups
  for(const pu of powerups){
    const p=1+Math.sin(pu.pulse)*.15, sz=pu.size*p;
    ctx.shadowBlur=12; ctx.shadowColor=pu.color;
    ctx.fillStyle=pu.color+'33'; ctx.beginPath(); ctx.arc(pu.x,pu.y,sz+3,0,Math.PI*2); ctx.fill();
    ctx.shadowBlur=0;
    ctx.font=`${Math.round(sz)}px sans-serif`; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(pu.icon, pu.x, pu.y);
    if(pu.age>8500&&Math.sin(pu.age/80)>0){ ctx.fillStyle=pu.color+'22'; ctx.beginPath(); ctx.arc(pu.x,pu.y,sz+8,0,Math.PI*2); ctx.fill(); }
  }

  // Particles
  for(const p of particles){
    ctx.globalAlpha=p.life; ctx.fillStyle=p.color;
    ctx.beginPath(); ctx.arc(p.x,p.y,p.r*p.life,0,Math.PI*2); ctx.fill();
  }
  ctx.globalAlpha=1;

  // Combo bar
  if(combo>=2&&playing){
    const bW=Math.min(combo/10,1)*(W*.4), bH=3*dpr, bX=W/2-W*.2, bY=H/2-6;
    ctx.fillStyle='#1a1a30'; ctx.fillRect(bX,bY,W*.4,bH);
    const g=ctx.createLinearGradient(bX,0,bX+bW,0);
    g.addColorStop(0,'#ffd700'); g.addColorStop(1,combo>=8?'#ff4444':'#ff9100');
    ctx.fillStyle=g; ctx.fillRect(bX,bY,bW,bH);
  }

  // Active effects
  let ey=H/2+12;
  if(effects.bigPaddle>Date.now()){ drawBadge('üî≤',ey); ey+=16; }
  if(effects.slowMo>Date.now()){ drawBadge('üïê',ey); ey+=16;
    const vg=ctx.createRadialGradient(W/2,H/2,W*.2,W/2,H/2,W*.6);
    vg.addColorStop(0,'transparent'); vg.addColorStop(1,'rgba(100,50,200,.1)');
    ctx.fillStyle=vg; ctx.fillRect(0,0,W,H);
  }

  ctx.restore();
}

function drawPad(p,color){
  ctx.shadowBlur=14*dpr; ctx.shadowColor=color; ctx.fillStyle=color;
  const r=3*dpr;
  ctx.beginPath();
  ctx.moveTo(p.x+r,p.y); ctx.lineTo(p.x+p.w-r,p.y);
  ctx.quadraticCurveTo(p.x+p.w,p.y,p.x+p.w,p.y+r);
  ctx.lineTo(p.x+p.w,p.y+p.h-r);
  ctx.quadraticCurveTo(p.x+p.w,p.y+p.h,p.x+p.w-r,p.y+p.h);
  ctx.lineTo(p.x+r,p.y+p.h);
  ctx.quadraticCurveTo(p.x,p.y+p.h,p.x,p.y+p.h-r);
  ctx.lineTo(p.x,p.y+r);
  ctx.quadraticCurveTo(p.x,p.y,p.x+r,p.y);
  ctx.fill(); ctx.shadowBlur=0;
}

function drawBadge(icon,y){ ctx.font=`${12*dpr}px sans-serif`; ctx.fillStyle='#aaa'; ctx.textAlign='left'; ctx.fillText(icon,6*dpr,y); }
function hexA(hex,a){ return `rgba(${parseInt(hex.slice(1,3),16)},${parseInt(hex.slice(3,5),16)},${parseInt(hex.slice(5,7),16)},${a})`; }

// ‚îÄ‚îÄ EVENTS ‚îÄ‚îÄ
$('startBtn').onclick=()=>{hideAll();playing=true;paused=false;};
$('nextBtn').onclick=()=>{if(currentLevel<LEVELS.length-1){currentLevel++;startLevel();}else{showToast('üèÜ HEPSƒ∞ TAMAM!');showMenu();}};
$('retryBtn').onclick=()=>startLevel();
$('menuBtn').onclick=()=>{if(paused){hideAll();paused=false;}else showMenu();};
$('resumeBtn').onclick=()=>{hideAll();paused=false;};

addEventListener('resize',()=>{resize();initPaddles();});

// ‚îÄ‚îÄ BOOT ‚îÄ‚îÄ
resize(); startLevel(); requestAnimationFrame(loop);
</script>
</body>
</html>
