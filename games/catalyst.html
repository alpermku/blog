<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Catalyst - Arcade</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;700&display=swap');
        *{margin:0;padding:0;box-sizing:border-box}
        body{background:#06060f;overflow:hidden;font-family:'JetBrains Mono',monospace;color:#fff;user-select:none;display:flex;justify-content:center;align-items:center;height:100vh;flex-direction:column}
        canvas{border:2px solid rgba(255,140,0,0.2);border-radius:4px;box-shadow:0 0 60px rgba(255,140,0,0.05);cursor:crosshair}
        .back-btn{position:fixed;top:14px;left:18px;z-index:20;font-family:'JetBrains Mono',monospace;font-size:13px;color:rgba(255,255,255,0.35);text-decoration:none;transition:color .2s}
        .back-btn:hover{color:#fff}
        .ui{position:fixed;z-index:10;pointer-events:none;width:100%;height:100%}
        .hud{position:absolute;top:14px;left:50%;transform:translateX(-50%);display:flex;gap:18px;align-items:center}
        .hud-item{font-family:'Press Start 2P',cursive;font-size:10px}
        .hud-title{color:#ff8c00;font-size:12px;text-shadow:0 0 10px rgba(255,140,0,0.5)}
        .hud-score{color:#fff}
        .hud-level{color:#44ffaa}
        .hud-clicks{color:#00c8ff}
        .hud-stars{color:#ffd700;font-size:12px}
        #overlay{position:fixed;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:30;pointer-events:all;background:rgba(6,6,15,0.92)}
        #overlay.hidden{display:none}
        #overlay h1{font-family:'Press Start 2P',cursive;font-size:24px;color:#ff8c00;text-shadow:0 0 30px rgba(255,140,0,0.4);margin-bottom:20px}
        #overlay h2{font-family:'Press Start 2P',cursive;font-size:16px;color:#fff;margin-bottom:12px}
        #overlay p{font-size:13px;color:rgba(255,255,255,0.6);max-width:500px;text-align:center;line-height:1.8;margin-bottom:8px}
        #overlay .stars-display{font-size:32px;margin:16px 0}
        #overlay .btn{font-family:'Press Start 2P',cursive;font-size:11px;color:#06060f;background:#ff8c00;border:none;padding:14px 28px;border-radius:6px;cursor:pointer;margin-top:18px;transition:all .2s;pointer-events:all}
        #overlay .btn:hover{background:#ffaa33;transform:scale(1.05)}
        #overlay .btn-secondary{background:transparent;color:#ff8c00;border:2px solid #ff8c00}
        #overlay .btn-secondary:hover{background:rgba(255,140,0,0.1)}
        .level-select{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin:20px 0}
        .level-btn{font-family:'Press Start 2P',cursive;font-size:10px;padding:12px 8px;background:rgba(255,255,255,0.05);border:2px solid rgba(255,255,255,0.1);border-radius:6px;color:#fff;cursor:pointer;text-align:center;transition:all .2s;pointer-events:all}
        .level-btn:hover{border-color:#ff8c00;background:rgba(255,140,0,0.1)}
        .level-btn.locked{opacity:0.3;cursor:not-allowed;pointer-events:none}
        .level-btn.current{border-color:#ff8c00;background:rgba(255,140,0,0.15)}
        .level-btn .lvl-stars{font-size:8px;display:block;margin-top:4px;color:#ffd700}
        .achievements{position:fixed;top:50px;right:20px;z-index:25;display:flex;flex-direction:column;gap:8px}
        .achievement{font-family:'Press Start 2P',cursive;font-size:8px;background:rgba(255,215,0,0.15);border:1px solid #ffd700;color:#ffd700;padding:8px 14px;border-radius:4px;animation:achieveIn .5s ease-out,achieveOut .5s ease-in 3s forwards;white-space:nowrap}
        @keyframes achieveIn{from{transform:translateX(100px);opacity:0}to{transform:translateX(0);opacity:1}}
        @keyframes achieveOut{to{transform:translateX(100px);opacity:0}}
        .stat-row{display:flex;gap:30px;margin:8px 0;align-items:center}
        .stat-label{font-family:'Press Start 2P',cursive;font-size:8px;color:rgba(255,255,255,0.4)}
        .stat-value{font-family:'Press Start 2P',cursive;font-size:11px;color:#fff}
    </style>
</head>
<body>
    <a href="../games.html" class="back-btn">‚Üê Arcade</a>
    <div class="ui">
        <div class="hud">
            <span class="hud-item hud-title">CATALYST</span>
            <span class="hud-item hud-score" id="hScore">0</span>
            <span class="hud-item hud-level" id="hLevel">LV 1</span>
            <span class="hud-item hud-clicks" id="hClicks">‚óè ‚óè</span>
            <span class="hud-item hud-stars" id="hStars"></span>
        </div>
    </div>
    <div id="overlay">
        <h1>CATALYST</h1>
        <p>Place explosions. Trigger chain reactions.<br>Detonate enough particles to earn stars and advance.</p>
        <button class="btn" onclick="startGame()">START</button>
    </div>
    <div class="achievements" id="achievements"></div>
    <canvas id="c"></canvas>

<script>
// ======================== CONFIG ========================
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
const overlay = document.getElementById('overlay');
const achieveBox = document.getElementById('achievements');

const W = Math.min(window.innerWidth - 20, 850);
const H = Math.min(window.innerHeight - 20, 620);
canvas.width = W; canvas.height = H;

// ======================== LEVEL DATA ========================
const LEVELS = [
    { particles: 25, clicks: 1, target3: 0.70, target2: 0.50, target1: 0.30, speed: 0.6, types: ['normal'],            name: 'SPARK',     bg: '#06060f' },
    { particles: 35, clicks: 1, target3: 0.65, target2: 0.45, target1: 0.25, speed: 0.8, types: ['normal'],            name: 'KINDLE',    bg: '#080812' },
    { particles: 40, clicks: 2, target3: 0.75, target2: 0.55, target1: 0.35, speed: 0.9, types: ['normal','fast'],     name: 'IGNITE',    bg: '#0a0a18' },
    { particles: 50, clicks: 2, target3: 0.70, target2: 0.50, target1: 0.30, speed: 1.0, types: ['normal','fast'],     name: 'BLAZE',     bg: '#0c0816' },
    { particles: 55, clicks: 2, target3: 0.68, target2: 0.48, target1: 0.28, speed: 1.1, types: ['normal','fast','mega'], name: 'INFERNO',  bg: '#0e0a14' },
    { particles: 60, clicks: 3, target3: 0.75, target2: 0.55, target1: 0.35, speed: 1.2, types: ['normal','fast','shy'],  name: 'NOVA',     bg: '#100c18' },
    { particles: 70, clicks: 3, target3: 0.72, target2: 0.52, target1: 0.32, speed: 1.3, types: ['normal','fast','shy','mega'], name: 'SUPERNOVA', bg: '#120a1a' },
    { particles: 80, clicks: 3, target3: 0.70, target2: 0.50, target1: 0.30, speed: 1.4, types: ['normal','fast','shy','mega'], name: 'QUASAR',    bg: '#14081c' },
    { particles: 90, clicks: 4, target3: 0.75, target2: 0.55, target1: 0.35, speed: 1.5, types: ['normal','fast','shy','mega','ghost'], name: 'PULSAR',  bg: '#16061e' },
    { particles:100, clicks: 4, target3: 0.80, target2: 0.60, target1: 0.40, speed: 1.6, types: ['normal','fast','shy','mega','ghost'], name: 'BIG BANG', bg: '#18041f' },
];

const PARTICLE_COLORS = {
    normal: '#ff8c00',
    fast:   '#00c8ff',
    mega:   '#ff4466',
    shy:    '#44ffaa',
    ghost:  '#c864ff',
};
const EXPLODE_R = 55;   // base explosion radius
const CHAIN_DELAY = 80; // ms between chain steps

// ======================== STATE ========================
let level = 0, score = 0, totalScore = 0;
let clicksLeft = 0, particles = [], explosions = [], floats = [];
let chainCount = 0, maxChain = 0, detonated = 0;
let phase = 'menu'; // menu | playing | waiting | result
let levelStars = new Array(10).fill(0); // 0-3 stars per level
let totalStarsEarned = 0;
let achievements = {};
let shakeTime = 0, slowMo = 0;
let bgHue = 0;

// Load save
try {
    const save = JSON.parse(localStorage.getItem('catalyst_save'));
    if (save) { levelStars = save.stars || levelStars; totalScore = save.totalScore || 0; achievements = save.achievements || {}; }
} catch(e) {}

function saveGame() {
    totalStarsEarned = levelStars.reduce((a,b) => a+b, 0);
    localStorage.setItem('catalyst_save', JSON.stringify({ stars: levelStars, totalScore, achievements }));
}

// ======================== ACHIEVEMENTS ========================
const ACHIEVE_DEFS = [
    { id: 'first_chain',   name: 'üîó First Chain',       desc: 'Get a 3+ chain',           check: () => maxChain >= 3 },
    { id: 'chain_5',       name: '‚õìÔ∏è Chain Master',      desc: '5+ chain reaction',         check: () => maxChain >= 5 },
    { id: 'chain_10',      name: 'üí• Chain God',          desc: '10+ chain reaction',        check: () => maxChain >= 10 },
    { id: 'perfect',       name: '‚≠ê Perfect',            desc: '3 stars on any level',      check: () => levelStars.some(s => s >= 3) },
    { id: 'all_stars_5',   name: 'üåü Rising Star',       desc: '15 total stars',            check: () => totalStarsEarned >= 15 },
    { id: 'all_stars_10',  name: '‚ú® Constellation',     desc: '25 total stars',            check: () => totalStarsEarned >= 25 },
    { id: 'score_5k',      name: 'üèÜ 5K Club',           desc: 'Score 5000+ on one level',  check: () => score >= 5000 },
    { id: 'complete',      name: 'üéÜ Big Bang',          desc: 'Beat all 10 levels',        check: () => levelStars.every(s => s >= 1) },
];

function checkAchievements() {
    ACHIEVE_DEFS.forEach(a => {
        if (!achievements[a.id] && a.check()) {
            achievements[a.id] = true;
            showAchievement(a.name);
            saveGame();
        }
    });
}

function showAchievement(text) {
    const el = document.createElement('div');
    el.className = 'achievement';
    el.textContent = `üèÖ ${text}`;
    achieveBox.appendChild(el);
    setTimeout(() => el.remove(), 4000);
}

// ======================== PARTICLES ========================
function spawnParticles() {
    particles = [];
    const cfg = LEVELS[level];
    const margin = 60;
    for (let i = 0; i < cfg.particles; i++) {
        const type = cfg.types[Math.floor(Math.random() * cfg.types.length)];
        const angle = Math.random() * Math.PI * 2;
        let speed = (0.3 + Math.random() * 0.7) * cfg.speed;
        let r = 6;
        
        if (type === 'fast') speed *= 1.8;
        if (type === 'mega') { r = 10; speed *= 0.6; }
        if (type === 'shy') speed *= 0.5;
        if (type === 'ghost') speed *= 1.2;

        particles.push({
            x: margin + Math.random() * (W - margin*2),
            y: margin + Math.random() * (H - margin*2),
            dx: Math.cos(angle) * speed,
            dy: Math.sin(angle) * speed,
            r, type, color: PARTICLE_COLORS[type],
            alive: true, exploding: false, explodeTime: 0, explodeR: 0,
            maxExplodeR: type === 'mega' ? EXPLODE_R * 1.6 : EXPLODE_R,
            alpha: 1, ghostPhase: Math.random() * Math.PI * 2,
            orbitAngle: Math.random() * Math.PI * 2,
            points: type === 'mega' ? 150 : type === 'ghost' ? 120 : 100,
        });
    }
}

// ======================== EXPLOSIONS ========================
function triggerExplosion(x, y, isClick = false) {
    explosions.push({
        x, y, r: 0, maxR: isClick ? EXPLODE_R * 0.8 : EXPLODE_R,
        life: 1, color: isClick ? '#ffffff' : '#ff8c00', isClick
    });
    shakeTime = isClick ? 5 : 8;
    
    // Find particles in range
    setTimeout(() => {
        const toExplode = [];
        particles.forEach(p => {
            if (!p.alive || p.exploding) return;
            const dist = Math.hypot(p.x - x, p.y - y);
            const range = isClick ? EXPLODE_R * 0.8 : p.maxExplodeR;
            if (dist < range + p.r) {
                toExplode.push(p);
            }
        });

        toExplode.forEach((p, i) => {
            setTimeout(() => {
                if (!p.alive || p.exploding) return;
                p.exploding = true;
                p.explodeTime = 0;
                detonated++;
                chainCount++;
                if (chainCount > maxChain) maxChain = chainCount;

                const chainMul = Math.min(chainCount, 15);
                const pts = p.points * chainMul;
                score += pts;

                // Float text
                const texts = [];
                if (chainCount >= 3) texts.push({ t: `CHAIN x${chainCount}`, c: '#ffd700', s: Math.min(14 + chainCount, 22) });
                texts.push({ t: `+${pts}`, c: p.color, s: 10 });
                texts.forEach((ft, fi) => {
                    floats.push({ x: p.x, y: p.y - fi * 18, text: ft.t, color: ft.c, size: ft.s, life: 1, dy: -1.2 - fi * 0.3 });
                });

                // Cascade: this particle explodes and triggers neighbors
                setTimeout(() => {
                    if (p.alive) {
                        p.alive = false;
                        triggerExplosion(p.x, p.y, false);
                        // Particle burst
                        for (let j = 0; j < 8; j++) {
                            const a = (j / 8) * Math.PI * 2;
                            floats.push({
                                x: p.x, y: p.y, dx: Math.cos(a) * 3, dy: Math.sin(a) * 3,
                                text: '', color: p.color, size: 3, life: 0.8, isParticle: true
                            });
                        }
                    }
                }, 200);
            }, i * CHAIN_DELAY);
        });

        // Check if chain is done after a delay
        setTimeout(() => checkChainDone(), (toExplode.length + 1) * CHAIN_DELAY + 500);
    }, isClick ? 0 : 50);
}

function checkChainDone() {
    const anyExploding = particles.some(p => p.exploding && p.alive);
    if (anyExploding) { setTimeout(checkChainDone, 300); return; }
    
    if (phase === 'playing' && clicksLeft <= 0) {
        setTimeout(() => { if (phase === 'playing') endLevel(); }, 800);
    }
}

// ======================== GAME FLOW ========================
function startGame() {
    showLevelSelect();
}

function showLevelSelect() {
    totalStarsEarned = levelStars.reduce((a,b) => a+b, 0);
    let html = `<h2>SELECT LEVEL</h2>`;
    html += `<div class="stat-row"><span class="stat-label">TOTAL STARS</span><span class="stat-value">${'‚≠ê'.repeat(totalStarsEarned)} (${totalStarsEarned}/30)</span></div>`;
    html += `<div class="stat-row"><span class="stat-label">TOTAL SCORE</span><span class="stat-value">${totalScore.toLocaleString()}</span></div>`;
    html += `<div class="level-select">`;
    for (let i = 0; i < 10; i++) {
        const unlocked = i === 0 || levelStars[i - 1] >= 1;
        const stars = levelStars[i];
        const starsStr = '‚òÖ'.repeat(stars) + '‚òÜ'.repeat(3 - stars);
        html += `<div class="level-btn ${unlocked ? '' : 'locked'}" onclick="${unlocked ? `selectLevel(${i})` : ''}">
            ${i + 1}<br><span style="font-size:8px;color:rgba(255,255,255,0.4)">${LEVELS[i].name}</span>
            <span class="lvl-stars">${stars > 0 ? starsStr : '‚òÜ‚òÜ‚òÜ'}</span>
        </div>`;
    }
    html += `</div>`;
    overlay.innerHTML = html;
    overlay.classList.remove('hidden');
    phase = 'menu';
}

function selectLevel(idx) {
    level = idx;
    score = 0; chainCount = 0; maxChain = 0; detonated = 0;
    clicksLeft = LEVELS[level].clicks;
    spawnParticles();
    overlay.classList.add('hidden');
    phase = 'playing';
    updateHUD();
}

function endLevel() {
    phase = 'result';
    const cfg = LEVELS[level];
    const total = cfg.particles;
    const pct = detonated / total;
    
    let stars = 0;
    if (pct >= cfg.target1) stars = 1;
    if (pct >= cfg.target2) stars = 2;
    if (pct >= cfg.target3) stars = 3;

    // Bonus points
    const starBonus = stars * 500;
    const chainBonus = maxChain * 100;
    score += starBonus + chainBonus;
    totalScore += score;

    if (stars > levelStars[level]) levelStars[level] = stars;
    saveGame();
    checkAchievements();

    const starsDisplay = ['‚≠ê','‚≠ê','‚≠ê'].map((s, i) => i < stars ? '‚≠ê' : '‚ö´').join(' ');
    const pctStr = Math.round(pct * 100);
    const pass = stars >= 1;

    let html = `<h2>${pass ? (stars === 3 ? '‚≠ê PERFECT! ‚≠ê' : 'LEVEL CLEAR!') : 'FAILED'}</h2>`;
    html += `<div class="stars-display">${starsDisplay}</div>`;
    html += `<div class="stat-row"><span class="stat-label">DETONATED</span><span class="stat-value">${detonated}/${total} (${pctStr}%)</span></div>`;
    html += `<div class="stat-row"><span class="stat-label">MAX CHAIN</span><span class="stat-value">x${maxChain}</span></div>`;
    html += `<div class="stat-row"><span class="stat-label">CHAIN BONUS</span><span class="stat-value">+${chainBonus}</span></div>`;
    html += `<div class="stat-row"><span class="stat-label">STAR BONUS</span><span class="stat-value">+${starBonus}</span></div>`;
    html += `<div class="stat-row"><span class="stat-label">TOTAL SCORE</span><span class="stat-value" style="color:#ff8c00;font-size:14px">${score.toLocaleString()}</span></div>`;
    
    if (pass && level < 9) {
        html += `<div style="display:flex;gap:12px;margin-top:16px">`;
        html += `<button class="btn" onclick="selectLevel(${level + 1})">NEXT LEVEL ‚Üí</button>`;
        html += `<button class="btn btn-secondary" onclick="selectLevel(${level})">RETRY</button>`;
        html += `</div>`;
    } else if (!pass) {
        html += `<button class="btn" onclick="selectLevel(${level})">RETRY</button>`;
    } else {
        html += `<p style="color:#ffd700;margin-top:12px">üéÜ ALL LEVELS COMPLETE!</p>`;
    }
    html += `<button class="btn btn-secondary" style="margin-top:8px" onclick="showLevelSelect()">LEVEL SELECT</button>`;

    overlay.innerHTML = html;
    overlay.classList.remove('hidden');
}

// ======================== INPUT ========================
canvas.addEventListener('click', e => {
    if (phase !== 'playing' || clicksLeft <= 0) return;
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    clicksLeft--;
    chainCount = 0;
    triggerExplosion(x, y, true);
    if (clicksLeft <= 0) {
        // Wait for chains to finish
        setTimeout(() => checkChainDone(), 2000);
    }
    updateHUD();
});

canvas.addEventListener('touchstart', e => {
    e.preventDefault();
    if (phase !== 'playing' || clicksLeft <= 0) return;
    const rect = canvas.getBoundingClientRect();
    const x = e.touches[0].clientX - rect.left;
    const y = e.touches[0].clientY - rect.top;
    clicksLeft--;
    chainCount = 0;
    triggerExplosion(x, y, true);
    if (clicksLeft <= 0) setTimeout(() => checkChainDone(), 2000);
    updateHUD();
}, { passive: false });

// ======================== HUD ========================
function updateHUD() {
    document.getElementById('hScore').textContent = score.toLocaleString();
    document.getElementById('hLevel').textContent = `LV ${level + 1}`;
    document.getElementById('hClicks').textContent = '‚óè '.repeat(clicksLeft).trim() || '‚Äî';
    const s = levelStars[level];
    document.getElementById('hStars').textContent = '‚òÖ'.repeat(s) + '‚òÜ'.repeat(3 - s);
}

// ======================== UPDATE ========================
function update() {
    if (phase !== 'playing' && phase !== 'result') return;

    const cfg = LEVELS[level];

    particles.forEach(p => {
        if (!p.alive || p.exploding) return;

        // Movement
        p.x += p.dx;
        p.y += p.dy;

        // Bounce off walls
        if (p.x - p.r < 0) { p.x = p.r; p.dx = Math.abs(p.dx); }
        if (p.x + p.r > W) { p.x = W - p.r; p.dx = -Math.abs(p.dx); }
        if (p.y - p.r < 0) { p.y = p.r; p.dy = Math.abs(p.dy); }
        if (p.y + p.r > H) { p.y = H - p.r; p.dy = -Math.abs(p.dy); }

        // Shy particles drift away from cursor (handled in draw via visual only)
        // Ghost particles phase in and out
        if (p.type === 'ghost') {
            p.ghostPhase += 0.03;
            p.alpha = 0.3 + Math.sin(p.ghostPhase) * 0.35 + 0.35;
        }
    });

    // Exploding particles expand
    particles.forEach(p => {
        if (p.exploding && p.alive) {
            p.explodeTime += 16;
            p.explodeR = Math.min(p.explodeTime * 0.3, p.maxExplodeR * 0.4);
            if (p.explodeTime > 300) {
                p.alive = false;
            }
        }
    });

    // Explosions
    explosions = explosions.filter(e => {
        e.r += 4;
        e.life -= 0.04;
        return e.life > 0;
    });

    // Floats
    floats = floats.filter(f => {
        if (f.isParticle) {
            f.x += (f.dx || 0);
            f.y += (f.dy || 0);
            f.dy += 0.1;
        } else {
            f.y += f.dy;
        }
        f.life -= 0.018;
        return f.life > 0;
    });

    if (shakeTime > 0) shakeTime--;
    updateHUD();
}

// ======================== DRAW ========================
function draw() {
    ctx.save();
    if (shakeTime > 0) {
        const i = shakeTime * 0.7;
        ctx.translate((Math.random()-0.5)*i, (Math.random()-0.5)*i);
    }

    // Background
    const cfg = LEVELS[level] || LEVELS[0];
    ctx.fillStyle = cfg.bg;
    ctx.fillRect(0, 0, W, H);

    // Subtle grid
    ctx.strokeStyle = 'rgba(255,140,0,0.02)';
    ctx.lineWidth = 1;
    for (let x = 0; x < W; x += 50) { ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke(); }
    for (let y = 0; y < H; y += 50) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke(); }

    // Target zone indicators (during play)
    if (phase === 'playing' && clicksLeft > 0) {
        // Subtle range preview on cursor would be nice but keep it clean
    }

    // Explosions (behind particles)
    explosions.forEach(e => {
        const grad = ctx.createRadialGradient(e.x, e.y, 0, e.x, e.y, e.r);
        grad.addColorStop(0, `rgba(255,255,255,${e.life * 0.3})`);
        grad.addColorStop(0.3, `rgba(255,140,0,${e.life * 0.2})`);
        grad.addColorStop(1, 'rgba(255,140,0,0)');
        ctx.fillStyle = grad;
        ctx.beginPath(); ctx.arc(e.x, e.y, e.r, 0, Math.PI * 2); ctx.fill();
    });

    // Particles
    particles.forEach(p => {
        if (!p.alive) return;
        ctx.globalAlpha = p.alpha || 1;

        if (p.exploding) {
            // Exploding animation
            const progress = p.explodeTime / 300;
            ctx.globalAlpha = 1 - progress;
            
            // Expanding ring
            ctx.strokeStyle = p.color;
            ctx.lineWidth = 2;
            ctx.shadowColor = p.color;
            ctx.shadowBlur = 15;
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.r + p.explodeR, 0, Math.PI * 2);
            ctx.stroke();

            // Core flash
            ctx.fillStyle = '#fff';
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.r * (1 - progress * 0.5), 0, Math.PI * 2);
            ctx.fill();
            ctx.shadowBlur = 0;
        } else {
            // Normal particle
            ctx.fillStyle = p.color;
            ctx.shadowColor = p.color;
            ctx.shadowBlur = p.type === 'mega' ? 18 : 10;
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
            ctx.fill();

            // Inner glow
            ctx.fillStyle = 'rgba(255,255,255,0.4)';
            ctx.beginPath();
            ctx.arc(p.x - p.r * 0.2, p.y - p.r * 0.2, p.r * 0.4, 0, Math.PI * 2);
            ctx.fill();

            ctx.shadowBlur = 0;

            // Type indicators
            if (p.type === 'fast') {
                ctx.strokeStyle = 'rgba(0,200,255,0.3)';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(p.x - p.dx * 5, p.y - p.dy * 5);
                ctx.lineTo(p.x, p.y);
                ctx.stroke();
            }
            if (p.type === 'mega') {
                ctx.strokeStyle = 'rgba(255,68,102,0.3)';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.maxExplodeR * 0.3, 0, Math.PI * 2);
                ctx.stroke();
            }
            if (p.type === 'shy') {
                // Slight wobble visual
                ctx.strokeStyle = 'rgba(68,255,170,0.2)';
                ctx.setLineDash([2, 4]);
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.r + 4, 0, Math.PI * 2);
                ctx.stroke();
                ctx.setLineDash([]);
            }
        }
        ctx.globalAlpha = 1;
    });

    // Float texts and particle effects
    floats.forEach(f => {
        ctx.globalAlpha = f.life;
        if (f.isParticle) {
            ctx.fillStyle = f.color;
            ctx.fillRect(f.x - f.size/2, f.y - f.size/2, f.size, f.size);
        } else {
            ctx.fillStyle = f.color;
            ctx.font = `${f.size}px "Press Start 2P"`;
            ctx.textAlign = 'center';
            ctx.shadowColor = f.color;
            ctx.shadowBlur = 8;
            ctx.fillText(f.text, f.x, f.y);
            ctx.shadowBlur = 0;
        }
    });
    ctx.globalAlpha = 1;

    // Click indicator when playing
    if (phase === 'playing' && clicksLeft > 0) {
        ctx.fillStyle = 'rgba(255,255,255,0.03)';
        ctx.font = '10px "Press Start 2P"';
        ctx.textAlign = 'center';
        ctx.fillText('CLICK TO DETONATE', W/2, H - 15);
    }
    if (phase === 'playing' && clicksLeft <= 0 && particles.some(p => p.alive)) {
        ctx.fillStyle = 'rgba(255,140,0,0.4)';
        ctx.font = '10px "Press Start 2P"';
        ctx.textAlign = 'center';
        ctx.fillText('CHAIN REACTING...', W/2, H - 15);
    }

    // Progress bar at bottom
    if (phase === 'playing') {
        const total = LEVELS[level].particles;
        const pct = detonated / total;
        const target1 = LEVELS[level].target1;
        const target2 = LEVELS[level].target2;
        const target3 = LEVELS[level].target3;

        // Bar background
        ctx.fillStyle = 'rgba(255,255,255,0.05)';
        ctx.fillRect(20, H - 6, W - 40, 4);

        // Progress
        const barColor = pct >= target3 ? '#ffd700' : pct >= target2 ? '#44ffaa' : pct >= target1 ? '#ff8c00' : '#ff4466';
        ctx.fillStyle = barColor;
        ctx.fillRect(20, H - 6, (W - 40) * pct, 4);

        // Star thresholds
        [target1, target2, target3].forEach((t, i) => {
            const tx = 20 + (W - 40) * t;
            ctx.fillStyle = pct >= t ? '#ffd700' : 'rgba(255,255,255,0.2)';
            ctx.font = '8px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('‚òÖ', tx, H - 10);
        });
    }

    ctx.restore();
}

// ======================== LOOP ========================
function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
}

loop();
</script>
</body>
</html>
